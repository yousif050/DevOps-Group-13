# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  node_version: '22.x'

stages:
  - stage: Install
    jobs:
      - job: InstallDependencies
        steps:
          - task: UseNode@1
            inputs:
              version: '$(node_version)'
          - checkout: self
          - script: |
              npm ci
              cd frontend/auth-frontend && npm ci && cd ../..
              cd frontend/community-frontend && npm ci && cd ../..
              cd backend/auth-service && npm ci && cd ../..
              cd backend/community-service && npm ci && cd ../..
            displayName: 'Install dependencies with npm ci'

  - stage: Build
    jobs:
      - job: BuildApp
        steps:
          - task: UseNode@1
            inputs:
              version: '$(node_version)'
          
          # Install Vite globally to ensure it's available for builds
          - script: |
              npm install -g vite
            displayName: 'Install Vite Globally'

          # Now build with the globally installed Vite
          - script: |
              cd frontend/auth-frontend && npm run build
              cd ../community-frontend && npm run build
            displayName: 'Build React'

  - stage: Package
    jobs:
      - job: CreateArtifact
        steps:
          - task: CopyFiles@2
            inputs:
              contents: |
                frontend/auth-frontend/dist/**
                frontend/community-frontend/dist/**
                backend/**
              targetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'